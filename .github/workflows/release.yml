name: Build and Release v4.0

on:
  push:
    tags:
      - 'v4.*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: Windows
            artifact: AntigravityCleaner-Pro-Windows.zip
          - os: macos-latest
            platform: macOS
            artifact: AntigravityCleaner-Pro-macOS.zip
          - os: ubuntu-latest
            platform: Linux
            artifact: AntigravityCleaner-Pro-Linux.tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install customtkinter psutil pycryptodome rich pillow pyinstaller
      
      - name: Build (Windows)
        if: matrix.platform == 'Windows'
        shell: pwsh
        run: |
          python -m PyInstaller --onefile --windowed --name "AntigravityCleaner" `
            --add-data "src;src" --hidden-import=customtkinter --hidden-import=PIL `
            --hidden-import=PIL._tkinter_finder --version-file=version_info.txt `
            --manifest=app.manifest src/gui_apple.py
          
          New-Item -ItemType Directory -Path portable -Force
          Copy-Item dist/AntigravityCleaner.exe portable/
          Copy-Item README.md portable/
          Copy-Item LICENSE portable/
          New-Item -ItemType Directory -Path portable/data -Force
          
          Compress-Archive -Path portable/* -DestinationPath ${{ matrix.artifact }}
      
      - name: Build (macOS)
        if: matrix.platform == 'macOS'
        run: |
          python -m PyInstaller --onefile --windowed --name "AntigravityCleaner" \
            --add-data "src:src" --hidden-import=customtkinter --hidden-import=PIL \
            --hidden-import=PIL._tkinter_finder src/gui_apple.py
          
          mkdir -p portable
          cp dist/AntigravityCleaner portable/
          cp README.md portable/
          cp LICENSE portable/
          mkdir -p portable/data
          
          cd portable && zip -r ../${{ matrix.artifact }} . && cd ..
      
      - name: Build (Linux)
        if: matrix.platform == 'Linux'
        run: |
          python -m PyInstaller --onefile --name "AntigravityCleaner" \
            --add-data "src:src" --hidden-import=customtkinter --hidden-import=PIL \
            --hidden-import=PIL._tkinter_finder src/gui_apple.py
          
          mkdir -p portable
          cp dist/AntigravityCleaner portable/
          cp README.md portable/
          cp LICENSE portable/
          mkdir -p portable/data
          
          tar -czf ${{ matrix.artifact }} -C portable .
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: ${{ matrix.artifact }}
          retention-days: 5

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true
      
      - name: Display structure
        run: ls -R release-assets
      
      - name: Create Release with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          
          # Delete release if exists (for retry scenarios)
          gh release delete "$TAG_NAME" --yes 2>/dev/null || true
          
          # Create new release
          gh release create "$TAG_NAME" \
            --title "Antigravity Cleaner Pro $TAG_NAME" \
            --notes "## ğŸ’ Official Portable Release

          ### âœ¨ New in v4.0.0
          - **Premium Apple-Style UI** with Glassmorphism effects
          - **Google Services Test** - Real-time connectivity diagnostics
          - **Multi-browser Session Management** (Chrome, Edge, Brave, Firefox, Opera, Vivaldi, Arc, Safari)
          - **Network Optimization Tools** with DNS flush and diagnostics
          - **Encrypted Session Backups** using AES-256-GCM
          - **True Portable** - No installation required, data stored locally
          - **Bilingual Interface** - English & Persian (ÙØ§Ø±Ø³ÛŒ)

          ### ğŸ“¦ Package Contents
          Each ZIP/TAR contains:
          - \`AntigravityCleaner.exe\` (or binary for your platform)
          - \`README.md\` - Full documentation (EN/FA)
          - \`LICENSE\` - Proprietary license terms
          - \`data/\` - Auto-created folder for sessions and logs

          ### ğŸš€ Quick Start
          1. Extract the archive
          2. Run \`AntigravityCleaner\`
          3. No installation needed!

          ### ğŸŒ Powered by Tawana Network
          Copyright Â© 2024-2025 Tawana Mohammadi. All Rights Reserved.

          ---
          **Support:** [GitHub Issues](https://github.com/tawroot/antigravity-cleaner/issues)" \
            release-assets/*
